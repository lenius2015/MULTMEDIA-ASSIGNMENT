<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - OMUNJU SHOPPERS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/admin.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="admin-layout">
        <%- include('./partials/sidebar', { currentPage: 'dashboard' }) %>

        <div class="admin-main">
            <%- include('./partials/header', { pageTitle: 'Dashboard' }) %>

            <main class="admin-content">
                <!-- KPI Cards -->
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-icon sales">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="kpi-content">
                            <h3><%= stats.totalOrders %></h3>
                            <p>Total Orders</p>
                            <div class="kpi-trend up">
                                <i class="fas fa-arrow-up"></i>
                                <span>Active</span>
                            </div>
                        </div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-icon orders">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="kpi-content">
                            <h3><%= stats.totalUsers %></h3>
                            <p>Total Users</p>
                            <div class="kpi-trend up">
                                <i class="fas fa-arrow-up"></i>
                                <span>Registered</span>
                            </div>
                        </div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-icon products">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="kpi-content">
                            <h3><%= stats.totalProducts %></h3>
                            <p>Total Products</p>
                            <div class="kpi-trend up">
                                <i class="fas fa-arrow-up"></i>
                                <span>Available</span>
                            </div>
                        </div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-icon customers">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="kpi-content">
                            <h3><%= stats.totalMessages %></h3>
                            <p>Contact Messages</p>
                            <div class="kpi-trend up">
                                <i class="fas fa-arrow-up"></i>
                                <span>Inquiries</span>
                            </div>
                        </div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-icon auctions">
                            <i class="fas fa-gavel"></i>
                        </div>
                        <div class="kpi-content">
                            <h3><%= stats.activeAuctions || 0 %></h3>
                            <p>Active Auctions</p>
                            <div class="kpi-trend up">
                                <i class="fas fa-arrow-up"></i>
                                <span>Live</span>
                            </div>
                        </div>
                    </div>

                    <div class="kpi-card" onclick="window.location.href='/admin/notifications'" style="cursor: pointer;">
                        <div class="kpi-icon countdowns">
                            <i class="fas fa-paper-plane"></i>
                        </div>
                        <div class="kpi-content">
                            <h3>Send</h3>
                            <p>Push Notification</p>
                            <div class="kpi-trend up">
                                <i class="fas fa-arrow-right"></i>
                                <span>Click to Send</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Section -->
                <div class="chart-container">
                    <div class="card-header">
                        <h2 class="card-title">Sales Analytics</h2>
                        <div>
                            <button class="btn btn-secondary" id="btn-daily" onclick="loadAnalytics('daily')">Daily</button>
                            <button class="btn btn-secondary" id="btn-weekly" onclick="loadAnalytics('weekly')">Weekly</button>
                            <button class="btn btn-primary" id="btn-monthly" onclick="loadAnalytics('monthly')">Monthly</button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="card-header">
                        <h2 class="card-title">Order Status Distribution</h2>
                    </div>
                    <div class="chart-wrapper-small">
                        <canvas id="orderStatusChart"></canvas>
                    </div>
                </div>

                <!-- Recent Orders -->
                <div class="admin-card">
                    <div class="card-header">
                        <h2 class="card-title">Recent Orders</h2>
                        <a href="/admin/orders" class="btn btn-secondary">View All</a>
                    </div>
                    <div class="admin-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% recentOrders.forEach(order => { %>
                                <tr>
                                    <td><strong>#<%= order.id %></strong></td>
                                    <td>
                                        <div>
                                            <div><%= order.customer_name || 'Guest' %></div>
                                            <div style="font-size: 0.75rem; color: #64748b;"><%= order.customer_email %></div>
                                        </div>
                                    </td>
                                    <td><%= new Date(order.created_at).toLocaleDateString() %></td>
                                    <td>$<%= order.total_amount %></td>
                                    <td><span class="status <%= order.status === 'delivered' ? 'delivered' : order.status === 'pending' ? 'pending' : 'warning' %>"><%= order.status %></span></td>
                                </tr>
                                <% }); %>
                                <% if (recentOrders.length === 0) { %>
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #64748b;">No orders yet</td>
                                </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Recent Messages -->
                <div class="admin-card">
                    <div class="card-header">
                        <h2 class="card-title">Recent Messages</h2>
                        <a href="/admin/messages" class="btn btn-secondary">View All</a>
                    </div>
                    <div class="admin-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Subject</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% recentMessages.forEach(message => { %>
                                <tr>
                                    <td><%= message.name %></td>
                                    <td><%= message.email %></td>
                                    <td><%= message.subject %></td>
                                    <td><%= new Date(message.created_at).toLocaleDateString() %></td>
                                    <td>
                                        <button class="btn-icon" title="Reply" onclick="replyToMessage('<%= message.id %>')">
                                            <i class="fas fa-reply"></i>
                                        </button>
                                        <button class="btn-icon" title="Delete" onclick="deleteMessage('<%= message.id %>')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                <% }); %>
                                <% if (recentMessages.length === 0) { %>
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #64748b;">No messages yet</td>
                                </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Top Products -->
                <div class="admin-card">
                    <div class="card-header">
                        <h2 class="card-title">Top Products</h2>
                        <a href="/admin/products" class="btn btn-secondary">View All</a>
                    </div>
                    <div class="admin-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Sales</th>
                                    <th>Revenue</th>
                                    <th>Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% topProducts.forEach(product => { %>
                                <tr>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <img src="<%= product.image_url || '/images/product-placeholder.jpg' %>" alt="Product" style="width: 40px; height: 40px; border-radius: 4px; object-fit: cover;">
                                            <span><%= product.name %></span>
                                        </div>
                                    </td>
                                    <td><%= product.sales_count || 0 %></td>
                                    <td>$<%= product.total_revenue || 0 %></td>
                                    <td>$<%= product.price %></td>
                                </tr>
                                <% }); %>
                                <% if (topProducts.length === 0) { %>
                                <tr>
                                    <td colspan="4" style="text-align: center; color: #64748b;">No sales data yet</td>
                                </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script src="/admin.js"></script>
    <script src="/admin-buttons.js"></script>
    <script>
        // Chart instances
        let salesChart = null;
        let orderStatusChart = null;

        // Initialize charts on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            // Try to load real data, but use fallback if it fails
            try {
                loadAnalytics('monthly');
            } catch(e) {
                console.log('Using fallback chart data');
                loadFallbackData();
            }
            try {
                loadOrderStatusChart();
            } catch(e) {
                console.log('Using fallback status chart data');
            }
        });

        // Initialize all charts
        function initializeCharts() {
            // Sales Chart
            const salesCtx = document.getElementById('salesChart');
            if (salesCtx) {
                salesChart = new Chart(salesCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Revenue ($)',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Orders',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Revenue ($)'
                                }
                            },
                            y1: {
                                beginAtZero: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Orders'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        }
                    }
                });
            }

            // Order Status Chart
            const statusCtx = document.getElementById('orderStatusChart');
            if (statusCtx) {
                orderStatusChart = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#3b82f6',
                                '#10b981',
                                '#f59e0b',
                                '#ef4444',
                                '#8b5cf6',
                                '#ec4899'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            }
        }

        // Load analytics data
        function loadAnalytics(period) {
            // Update button states
            document.querySelectorAll('.chart-container .btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });
            const activeBtn = document.getElementById('btn-' + period);
            if (activeBtn) {
                activeBtn.classList.remove('btn-secondary');
                activeBtn.classList.add('btn-primary');
            }

            fetch(`/admin/api/analytics/sales?period=${period}`)
                .then(response => {
                    if (!response.ok) throw new Error('API error');
                    return response.json();
                })
                .then(data => {
                    if (data.success && salesChart && data.data.length > 0) {
                        const labels = data.data.map(item => {
                            if (period === 'daily') {
                                return new Date(item.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                            } else if (period === 'weekly') {
                                return new Date(item.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            } else {
                                return item.date;
                            }
                        });
                        
                        salesChart.data.labels = labels;
                        salesChart.data.datasets[0].data = data.data.map(item => parseFloat(item.revenue));
                        salesChart.data.datasets[1].data = data.data.map(item => item.orders);
                        salesChart.update();
                    } else {
                        // Use fallback data if no real data
                        loadFallbackData();
                    }
                })
                .catch(error => {
                    console.error('Error loading analytics:', error);
                    loadFallbackData();
                });
        }

        // Load fallback data for sales chart
        function loadFallbackData() {
            if (!salesChart) return;
            
            const fallbackLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
            salesChart.data.labels = fallbackLabels;
            salesChart.data.datasets[0].data = [1200, 1900, 1500, 2100, 1800, 2400];
            salesChart.data.datasets[1].data = [12, 19, 15, 21, 18, 24];
            salesChart.update();
        }

        // Load order status chart
        function loadOrderStatusChart() {
            fetch('/admin/api/analytics/order-status')
                .then(response => {
                    if (!response.ok) throw new Error('API error');
                    return response.json();
                })
                .then(data => {
                    if (data.success && orderStatusChart && data.data.length > 0) {
                        orderStatusChart.data.labels = data.data.map(item => item.status.charAt(0).toUpperCase() + item.status.slice(1));
                        orderStatusChart.data.datasets[0].data = data.data.map(item => item.count);
                        orderStatusChart.update();
                    } else {
                        // Use fallback data
                        loadFallbackStatusData();
                    }
                })
                .catch(error => {
                    console.error('Error loading order status:', error);
                    loadFallbackStatusData();
                });
        }

        // Load fallback data for status chart
        function loadFallbackStatusData() {
            if (!orderStatusChart) return;
            
            orderStatusChart.data.labels = ['Pending', 'Confirmed', 'Shipped', 'Delivered', 'Cancelled'];
            orderStatusChart.data.datasets[0].data = [4, 4, 3, 3, 1];
            orderStatusChart.update();
        }

        // Reply to message
        function replyToMessage(messageId) {
            window.location.href = `/admin/messages?reply=${messageId}`;
        }

        // Delete message
        function deleteMessage(messageId) {
            if (confirm('Are you sure you want to delete this message?')) {
                fetch(`/admin/messages/${messageId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Message deleted successfully', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        showToast('Failed to delete message', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error deleting message:', error);
                    showToast('Failed to delete message', 'error');
                });
            }
        }

        // Make functions globally available
        window.loadAnalytics = loadAnalytics;
        window.replyToMessage = replyToMessage;
        window.deleteMessage = deleteMessage;
    </script>
</body>
</html>