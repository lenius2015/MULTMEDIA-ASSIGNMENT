<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promotions & Deals - OMUNJU SHOPPERS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/admin.css">
</head>
<body>
    <div class="admin-layout">
        <%- include('./partials/sidebar', { currentPage: 'promotions' }) %>

        <div class="admin-main">
            <%- include('./partials/header', { pageTitle: 'Promotions & Deals' }) %>

            <main class="admin-content">
                <div class="admin-card">
                    <div class="card-header">
                        <h2 class="card-title">Product Promotions Management</h2>
                        <p class="card-subtitle">Manage discounts and promotional pricing for products</p>
                    </div>

                    <!-- Products Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 24px;">
                        <% if (products && products.length > 0) { %>
                            <% products.forEach(product => { %>
                                <div class="admin-card product-card" data-product-id="<%= product.id %>">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                                        <div>
                                            <h3 style="margin: 0; font-size: 1.125rem;"><%= product.name %></h3>
                                            <p style="margin: 4px 0 0 0; color: #64748b;"><%= product.description ? product.description.substring(0, 50) + '...' : 'No description' %></p>
                                        </div>
                                        <% if (product.discount > 0) { %>
                                            <span class="status delivered">On Sale</span>
                                        <% } else { %>
                                            <span class="status cancelled">No Discount</span>
                                        <% } %>
                                    </div>

                                    <div style="margin-bottom: 16px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span>Original Price:</span>
                                            <strong>$<%= product.price %></strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span>Discount:</span>
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <input type="number" class="discount-input" value="<%= product.discount %>"
                                                       min="0" max="100" step="0.1" data-product-id="<%= product.id %>"
                                                       style="width: 60px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">
                                                <span>%</span>
                                            </div>
                                        </div>
                                        <% if (product.discount > 0) { %>
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                                <span>Sale Price:</span>
                                                <strong style="color: #e74c3c;">$<%= product.discounted_price %></strong>
                                            </div>
                                            <div style="display: flex; justify-content: space-between;">
                                                <span>You Save:</span>
                                                <strong style="color: #27ae60;">$<%= product.discount_amount %></strong>
                                            </div>
                                        <% } %>
                                    </div>

                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn btn-primary btn-sm update-discount-btn" data-product-id="<%= product.id %>">
                                            <i class="fas fa-save"></i>
                                            Update
                                        </button>
                                        <% if (product.discount > 0) { %>
                                            <button class="btn btn-warning btn-sm remove-discount-btn" data-product-id="<%= product.id %>">
                                                <i class="fas fa-times"></i>
                                                Remove
                                            </button>
                                        <% } %>
                                    </div>
                                </div>
                            <% }); %>
                        <% } else { %>
                            <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #64748b;">
                                <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 16px;"></i>
                                <h3>No products found</h3>
                                <p>Add products to start managing promotions</p>
                            </div>
                        <% } %>
                    </div>

                    <!-- Pagination -->
                    <% if (totalPages > 1) { %>
                        <div style="display: flex; justify-content: center; margin-top: 24px;">
                            <% if (page > 1) { %>
                                <a href="?page=<%= page - 1 %>" class="btn btn-secondary">Previous</a>
                            <% } %>

                            <% for (let i = Math.max(1, page - 2); i <= Math.min(totalPages, page + 2); i++) { %>
                                <a href="?page=<%= i %>" class="btn <%= i === page ? 'btn-primary' : 'btn-secondary' %>"><%= i %></a>
                            <% } %>

                            <% if (page < totalPages) { %>
                                <a href="?page=<%= page + 1 %>" class="btn btn-secondary">Next</a>
                            <% } %>
                        </div>
                    <% } %>
                </div>

                <!-- Promotion Performance -->
                <div class="admin-card">
                    <div class="card-header">
                        <h2 class="card-title">Promotion Performance</h2>
                    </div>
                    <div class="admin-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Promotion</th>
                                    <th>Views</th>
                                    <th>Clicks</th>
                                    <th>Conversions</th>
                                    <th>Revenue</th>
                                    <th>ROI</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Winter Sale</td>
                                    <td>12,345</td>
                                    <td>2,456</td>
                                    <td>456</td>
                                    <td>$45,678</td>
                                    <td><span style="color: #10b981;">+245%</span></td>
                                </tr>
                                <tr>
                                    <td>New Customer Discount</td>
                                    <td>8,901</td>
                                    <td>1,234</td>
                                    <td>234</td>
                                    <td>$12,345</td>
                                    <td><span style="color: #10b981;">+180%</span></td>
                                </tr>
                                <tr>
                                    <td>Flash Sale</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>$0</td>
                                    <td>N/A</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add/Edit Promotion Modal -->
    <div class="modal" id="add-promotion-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="promotion-modal-title">Create New Promotion</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="promotion-form">
                <div class="form-group">
                    <label for="promotion-name">Promotion Name *</label>
                    <input type="text" id="promotion-name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="promotion-description">Description</label>
                    <textarea id="promotion-description" name="description" rows="3"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label for="promotion-discount">Discount Percentage *</label>
                        <input type="number" id="promotion-discount" name="discount" min="1" max="100" required>
                    </div>
                    <div class="form-group">
                        <label for="promotion-type">Discount Type</label>
                        <select id="promotion-type" name="type">
                            <option value="percentage">Percentage</option>
                            <option value="fixed">Fixed Amount</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label for="promotion-start">Start Date</label>
                        <input type="datetime-local" id="promotion-start" name="start_date">
                    </div>
                    <div class="form-group">
                        <label for="promotion-end">End Date</label>
                        <input type="datetime-local" id="promotion-end" name="end_date">
                    </div>
                </div>
                <div class="form-group">
                    <label for="promotion-products">Select Products</label>
                    <select id="promotion-products" name="products" multiple style="height: 120px;">
                        <option value="1">Premium Cotton T-Shirt</option>
                        <option value="2">Leather Jacket</option>
                        <option value="3">Designer Jeans</option>
                        <option value="4">Summer Dress</option>
                    </select>
                    <small>Hold Ctrl/Cmd to select multiple products</small>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="promotion-status" name="status" checked>
                        Active (immediately available to customers)
                    </label>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('add-promotion-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Promotion</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script src="/admin.js"></script>
    <script>
        // Initialize discount inputs and buttons
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners to discount inputs
            document.querySelectorAll('.discount-input').forEach(input => {
                input.addEventListener('input', function() {
                    updatePricePreview(this);
                });
                input.addEventListener('change', function() {
                    updatePricePreview(this);
                });
            });

            // Add event listeners to buttons using event delegation
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('update-discount-btn') || e.target.closest('.update-discount-btn')) {
                    const button = e.target.classList.contains('update-discount-btn') ? e.target : e.target.closest('.update-discount-btn');
                    const productId = button.dataset.productId;
                    updateDiscount(productId);
                }

                if (e.target.classList.contains('remove-discount-btn') || e.target.closest('.remove-discount-btn')) {
                    const button = e.target.classList.contains('remove-discount-btn') ? e.target : e.target.closest('.remove-discount-btn');
                    const productId = button.dataset.productId;
                    removeDiscount(productId);
                }
            });
        });

        function updatePricePreview(input) {
            const productId = input.dataset.productId;
            const discount = parseFloat(input.value) || 0;
            const card = input.closest('.product-card');

            // Find original price
            const originalPriceText = card.querySelector('strong');
            if (!originalPriceText) return;

            const originalPrice = parseFloat(originalPriceText.textContent.replace('$', ''));

            if (discount > 0) {
                const discountedPrice = (originalPrice * (1 - discount / 100)).toFixed(2);
                const discountAmount = (originalPrice * discount / 100).toFixed(2);

                // Update or create sale price display
                let salePriceDiv = card.querySelector('.sale-price-info');
                if (!salePriceDiv) {
                    salePriceDiv = document.createElement('div');
                    salePriceDiv.className = 'sale-price-info';
                    salePriceDiv.style.cssText = 'display: flex; justify-content: space-between; margin-bottom: 8px;';
                    card.querySelector('div[style*="margin-bottom: 16px"]').appendChild(salePriceDiv);
                }
                salePriceDiv.innerHTML = `
                    <span>Sale Price:</span>
                    <strong style="color: #e74c3c;">$${discountedPrice}</strong>
                `;

                // Update or create savings display
                let savingsDiv = card.querySelector('.savings-info');
                if (!savingsDiv) {
                    savingsDiv = document.createElement('div');
                    savingsDiv.className = 'savings-info';
                    savingsDiv.style.cssText = 'display: flex; justify-content: space-between;';
                    card.querySelector('div[style*="margin-bottom: 16px"]').appendChild(savingsDiv);
                }
                savingsDiv.innerHTML = `
                    <span>You Save:</span>
                    <strong style="color: #27ae60;">$${discountAmount}</strong>
                `;
            } else {
                // Remove sale price and savings if discount is 0
                const salePriceDiv = card.querySelector('.sale-price-info');
                const savingsDiv = card.querySelector('.savings-info');
                if (salePriceDiv) salePriceDiv.remove();
                if (savingsDiv) savingsDiv.remove();
            }
        }

        async function updateDiscount(productId) {
            const input = document.querySelector(`.discount-input[data-product-id="${productId}"]`);
            if (!input) return;

            const discount = parseFloat(input.value) || 0;

            if (discount < 0 || discount > 100) {
                alert('Discount must be between 0 and 100');
                return;
            }

            try {
                const response = await fetch(`/products/${productId}/discount`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ discount })
                });

                const result = await response.json();

                if (result.success) {
                    showToast('Discount updated successfully!', 'success');

                    // Update status badge
                    const card = input.closest('.product-card');
                    const statusBadge = card.querySelector('.status');
                    if (discount > 0) {
                        statusBadge.className = 'status delivered';
                        statusBadge.textContent = 'On Sale';
                    } else {
                        statusBadge.className = 'status cancelled';
                        statusBadge.textContent = 'No Discount';
                    }
                } else {
                    alert('Failed to update discount: ' + result.message);
                }
            } catch (error) {
                console.error('Error updating discount:', error);
                alert('Error updating discount');
            }
        }

        async function removeDiscount(productId) {
            const input = document.querySelector(`.discount-input[data-product-id="${productId}"]`);
            if (!input) return;

            if (confirm('Are you sure you want to remove this discount?')) {
                input.value = 0;
                updatePricePreview(input);
                await updateDiscount(productId);
            }
        }

        function showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1'};
                color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460'};
                padding: 12px 16px;
                border-radius: 4px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                z-index: 10000;
                max-width: 300px;
            `;
            toast.textContent = message;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
</body>
</html>